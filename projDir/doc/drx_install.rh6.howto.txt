# Preparing a DRX host for the DOW Pentek system
# ==============================================
#
# OS: RH6
#
# Hardware
# --------
# 
# This is generally a DELL T620.
# 
# Machine should have 2 CPUs, 32 GB RAM, extra fans.
# 2 high-speed system disks in RAID-1, hardware RAID controller.
# 
# RAID controller:
#
#   Move to slot 3

# Video card:
# 
#   Install good Nvidia graphics card, e.g. GeForce GT 610
#   Install in slot 4.
# 
# Penteks:
# 
#   Install in slots 2 and 5.
#   Install SCSI cable cards in slots 1 and 7.
#
#   IMPORTANT: on Pentek PCIe carrier card:
#     (a) Move jumper JB9 to pins 1/2. (Int A)
#     (b) Load updated PCI image to flash memory.
#     (c) Load DDC10 image to flash memory. 
# 
# Acromag:
# 
#   Install in slot 6.
# 
# BIOS
# ----
# 
#   Disable on-board video in the BIOS:
# 
#   Select:
# 
#     System Bios
#       -> Integrated Devices
#          -> Embedded Video Controller
#             -> Disabled
#
# FAN speed
# ---------
#
# In BIOS:
#  Configure IDRAC
#  Scroll down to 'Thermal'
#  Select (a) maximum performance
#         (b) fan offset - low
# 
# Install OS
# ----------
# 
# The following notes are from the install for Scientific LINUX 6.4:
# 
#   Install with basic video driver
#   English keyboard
#   Basic storage device
#   Discard data on RAID
#   Hostname: drx
#   Time: Etc/UTC
#   
#   Create custom disk partition layout:
# 
#    /      50 GB
#    /root  500 MB
#    /swap  16 GB
#    /home  rest
# 
#   Software development workstation
#   Customize:
#     Basic system: add yum repos
#     Virtualization: turn all off
#     Desktops: add KDE
#     Apps: add office
# 
#   Install:
#     If dependency errors occur, ignore and go on.
# 
#   After install:
#   
#     Perform software update from menu.
#   
#   Firewall:
#
#     Open port range 5432 - 5500
#     (Also on mgen).
# 
#   Add titan5 user:
# 
#     Add user titan5
#     Change titan5 shell to /bin/csh using 'chsh'.
# 

# install extra repos
# -------------------

  rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm

  rpm --import http://elrepo.org/RPM-GPG-KEY-elrepo.org
  rpm -Uvh http://elrepo.org/elrepo-release-6-5.el6.elrepo.noarch.rpm

# Install packages
# ----------------

# You will need:
# 
#     cvs
#     svn
#     scons
#     ftp
#    
#     gcc
#     g++
#     gfortran
#     Xvfb (virtual X server)
# 
#     fftw3-devel development (for radar moments)
#     log4cpp-devel
#     expat-devel (for udunits)
#     jasper-devel (for grib2)
# 
#     glibc-devel
#     libX11-devel (for X)
#     libXext-devel (if available)
#     bzip2-devel (for NEXRAD decompression)
#     zlib-devel
#     libpng-devel
#     libtiff-devel
#     qt4-devel (for Qt apps)
#     qwt-devel (for tcpscope)
#     glut-devel (for Open GL)
#     flex
#     compat-libstdc++-296.i686 (32-bit compat)
#     compat-libstdc++-33.i686  (32-bit compat)
#     boost-devel
#
#     hdf5
#     netcdf
#     udunits2
#
#     perl.Env
#     xorg-x11-fonts-misc
#     xorg-x11-fonts-75dpi
#     xorg-x11-fonts-100dpi

# You can install these with this command

  yum install cvs svn scons ftp gcc gcc-c++ gcc-gfortran Xvfb fftw3-devel log4cpp-devel expat-devel jasper-devel glibc-devel libX11-devel libXext-devel bzip2-devel zlib-devel libpng-devel libtiff-devel qt4-devel qwt-devel glut-devel flex compat-libstdc++-296.i686 compat-libstdc++-33.i686 boost-devel hdf5 netcdf udunits2 perl-Env xorg-x11-fonts-misc xorg-x11-fonts-75dpi xorg-x11-fonts-100dpi

#
# Make link for qmake
#
  cd /usr/bin
  ln -s qmake-qt4 qmake

# disable unwanted services - firewall
--------------------------------------

On RH7 and later:

  systemctl disable ip6tables
  systemctl disable iptables
  systemctl disable firewalld

# Video driver
# ------------

Option (a): install using yum:

    yum install nvidia-x11-drv

Option (b): install and build manually

  * Download relevant NVIDIA driver from web site
  * Disable nouveau drivers by updating /etc/default/grub, adding rdblacklist=nouveau to
    GRUB_CMDLINE_LINUX. For example:

    # cat /etc/default/grub
    GRUB_TIMEOUT=5
    GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
    GRUB_DEFAULT=saved
    GRUB_DISABLE_SUBMENU=true
    GRUB_TERMINAL_OUTPUT="console"
    GRUB_CMDLINE_LINUX="vconsole.keymap=us crashkernel=auto  vconsole.font=latarcyrheb-sun16 rhgb quiet rdblacklist=nouveau"
    GRUB_DISABLE_RECOVERY="true"

  * install new grub config

    grub2-mkconfig -o /boot/grub2/grub.cfg

  * reboot
  * shut down X

    telinit 3

  * Build NVIDIA driver:

    cd Downloads
    chmod +x NVIDIA-Linux-x86_64-340.24.run (or whatever it is called)
    ./NVIDIA-Linux-x86_64-340.24.run

  * reboot

# Install Java JDK
#  ----------------

# Download Java JDK tar file from Oracle.

# For example: 

  jdk-7u45-linux-x64.tar.gz

# As root:

  mkdir /usr/java
  cd /usr/java
  cp jdk-7u45-linux-x64.tar.gz .
  ln -s jdk1.7.0_45 latest

# So that you can reference java using:

  /usr/java/latest/bin/java

# and JAVA_HOME will be set to:

  setenv JAVA_HOME /usr/java/latest

# Check out dow project from cvs
# ------------------------------

  mkdir cvs
  cd cvs
  cvs co projects/titan/dow
  cvd co distribs/hawk
  ./distribs/hawk/do_checkout

# Check out dow project from svn
# ------------------------------

  mkdir svn/dow
  cd svn/dow
  svn co http://svn.eol.ucar.edu/svn/dow/trunk/src src

# or if svn server port has been forwarded locally:

  svn co http://localhost:8888/svn/dow/trunk/src src

# Update firmware on Penteks to support option 428
--------------------------------------------------

# As shipped, the Penteks do not natively support
# option 428, which is needed for our downconverters.

# Therefore, the firmware for Option 428 must be uploaded
# to the Penteks before use.

# Install ReadyFlow in /usr/local
# -------------------------------
#
# Do the following as root

  cd ~titan5/svn/dow/src/ReadyFlow
  cp 1.0/include/* /usr/local/include/
  cp 1.0/x86_64/include/* /usr/local/include/
  cp 1.0/x86_64/lib/*7142* /usr/local/lib

# as titan 5 do the following

  cd svn/dow/src/pentek

# edit tool_pentek.py and make the following change:

  readyflow -> readyflow_usr_local

# you can then remove the ReadyFlow directory, which is proprietary
# and cannot be distributed

# Install Acromag PMC730 driver
# -----------------------------

# Check out dow/dualFreq project.

# As root:

  cd /opt
  mkdir Acromag
  cd Acromag
  cp ~titan5/svn/dow/src/drivers/pmc730.tgz .
  tar xvfz pmc730.tgz
  cd pmc730/dev730
  make
  cp apmc730.ko /lib/modules/`uname -r`/kernel/drivers
  sudo depmod -a

# You can also build some testing utilities, but it isn't necessary:

  cd pmc730
  make

# Add the following lines to /etc/rc.local to create device nodes and
# load the driver module at boot time:

  #Acromag apmc730
  if [ ! -r /dev/apmc730_0 ]; then
    /bin/mknod -m 666 /dev/apmc730_0 c 46 0 #(1st PMC board)
    /bin/mknod -m 666 /dev/apmc730_1 c 46 1 #(2nd PMC board)
    /bin/mknod -m 666 /dev/apmc730_2 c 46 2 #(3rd PMC board)
    /bin/mknod -m 666 /dev/apmc730_3 c 46 3 #(4th PMC board)
  fi
  /sbin/modprobe apmc730

# Install Windriver for Pentek Readyflow
# --------------------------------------

# As root, perform the following:

  cd /opt
  cp ~titan5/svn/dow/src/drivers/WinDriver1031_64.tgz .
  tar xvfz WinDriver1031_64.tgz
  cd WinDriver1031_64/redist
  ./configure  --with-kernel-source=/lib/modules/`uname -r`/build
  make
  su
  make install

# Add the following to /etc/rc.local

  rmmod windrvr6
  /opt/WinDriver1031_64/redist/wdreg windrvr6 auto
  chmod 666 /dev/windrvr6

# You also need to change the permissions on the library files, to make
# them readable.

  cd /opt/WinDriver1031_64/lib/
  chmod +r *

# Download and build netcdf / hdf5
# --------------------------------

  ftp ftp.rap.ucar.edu
 
# log in as anonymous

  cd pub/titan/netcdf
  prompt
  mget *
  quit

# install in /usr/local

  chmod +x ./build_netcdf
  sudo ./build_netcdf /usr/local

# Download and build tdrp
# -----------------------

  ftp ftp.rap.ucar.edu
 
# log in as anonymous

  cd pub/titan/tdrp
  prompt
  mget *
  quit

# install in /usr/local

  chmod +x ./build_tdrp
  sudo ./build_netcdf /usr/local

# Compile dowdrx
# --------------

  cd
  cd svn/dow/src/dowdrx
  scons -u -j 8 

# Check out titan distribution
# ----------------------------

  cd
  mkdir cvs
  cd cvs
  cvs co distribs/titan
  ./distribs/titan/do_checkout

# Configure project
# -----------------

  sudo mkdir /data
  sudo chown titan5 /data

  cd projects/titan/dow/dualFreq/system/scripts
  ./configure_host

# select host type 'drx'

  source ~/.cshcr

# build titan
# -----------

  cd ~/cvs
  ./distribs/titan/copy_build_scripts_and_docs 
  touch ~/.titan_build_env
  ./build_titan

# check for compile errors, install packages as appropriate




